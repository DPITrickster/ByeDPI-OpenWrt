name: build

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 */14 * *'

env:
  REPO: 'hufrea/byedpi'
  PKG_PATH: byedpi
  SDKDIR: /builder

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Checkout repository (to read .last_release_tag)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get upstream latest release tag
        id: get_tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/${REPO}/releases/latest" | grep -Po '"tag_name": "\K.+?(?=")')
          echo "Latest upstream tag: $TAG"

          if [ -f .last_release_tag ]; then
            LAST=$(cat .last_release_tag)
          else
            LAST=""
          fi
          echo "Last processed tag: $LAST"

          if [ "$TAG" = "$LAST" ]; then
            echo "tag=SKIP" >> $GITHUB_OUTPUT
            echo "No new release. Skipping build."
            exit 0
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch:
          - openwrt-19.07
          - openwrt-21.02
          - openwrt-22.03
          - openwrt-23.05
          - openwrt-24.10
          - openwrt-25.12.0-rc1
          - openwrt-25.12.0-rc2
          - openwrt-25.12.0-rc3
          - openwrt-25.12.0-rc4
        arch:
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_arm1176jzf-s_vfp
          - arm_arm926ej-s
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_fa526
          - arm_mpcore
          - arm_xscale
          - mips64_octeonplus
          - mips_24kc
          - mips_4kec
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - x86_64
        exclude:
          - branch: openwrt-19.07
            arch: arm_cortex-a7
          - branch: openwrt-19.07
            arch: arm_cortex-a7_vfpv4
          - branch: openwrt-19.07
            arch: mips_4kec
          - branch: openwrt-21.02
            arch: arm_cortex-a7_vfpv4
          - branch: openwrt-24.10
            arch: arm_mpcore
          - branch: openwrt-25.12.0-rc1
            arch: mips_4kec
          - branch: openwrt-25.12.0-rc2
            arch: mips_4kec
          - branch: openwrt-25.12.0-rc3
            arch: mips_4kec
          - branch: openwrt-25.12.0-rc4
            arch: mips_4kec
        include:
          - branch: openwrt-24.10
            arch: aarch64_cortex-a76
          - branch: openwrt-25.12.0-rc1
            arch: aarch64_cortex-a76
          - branch: openwrt-25.12.0-rc2
            arch: aarch64_cortex-a76
          - branch: openwrt-25.12.0-rc3
            arch: aarch64_cortex-a76
          - branch: openwrt-25.12.0-rc4
            arch: aarch64_cortex-a76

    container:
      image: ghcr.io/openwrt/sdk:${{ matrix.arch }}-${{ matrix.branch }}
      options: --user root

    env:
      UPSTREAM_TAG: ${{ needs.check.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect PKGTYPE and WORKDIR
        id: detect
        run: |
          BR="${{ matrix.branch }}"
          if echo "$BR" | grep -q "25.12"; then
            PKGTYPE=apk
          else
            PKGTYPE=ipk
          fi

          if [ "$BR" = "openwrt-19.07" ]; then
            WORKDIR=/home/build/openwrt
          else
            WORKDIR=${SDKDIR}
          fi

          echo "pkgtype=$PKGTYPE" >> $GITHUB_OUTPUT
          echo "workdir=$WORKDIR" >> $GITHUB_OUTPUT
          echo "arch=${{ matrix.arch }}" >> $GITHUB_OUTPUT

      - name: Run setup.sh when needed
        working-directory: ${{ steps.detect.outputs.workdir }}
        run: |
          BR="${{ matrix.branch }}"
          case "$BR" in
            *23.05*|*24.10*|*25.12*)
              if [ -f ./setup.sh ]; then
                HOME="${{ steps.detect.outputs.workdir }}" ./setup.sh || true
              fi
              ;;
          esac

      - name: Prepare package (set version)
        working-directory: ${{ steps.detect.outputs.workdir }}
        env:
          UPSTREAM_TAG: ${{ env.UPSTREAM_TAG }}
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          V=${UPSTREAM_TAG#v}
          sed -i "s|@VERSION@|$V|" "${PKG_PATH}/Makefile" || true

      - name: Add feeds and compile package
        id: compile
        working-directory: ${{ steps.detect.outputs.workdir }}
        env:
          ARCH: ${{ matrix.arch }}
          BRANCH: ${{ matrix.branch }}
          PKGTYPE: ${{ steps.detect.outputs.pkgtype }}
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          echo "src-link ${PKG_PATH} $GITHUB_WORKSPACE" >> feeds.conf
          ./scripts/feeds update ${PKG_PATH} || true
          ./scripts/feeds install -a -p ${PKG_PATH} || true
          make defconfig || true
          make package/${PKG_PATH}/compile V=s -j$(nproc) || true

          OUT_TAR="$GITHUB_WORKSPACE/${PKGTYPE}-${BRANCH}-${ARCH}.tar"
          find ./bin/packages -type f -name "*.${PKGTYPE}" -print0 \
            | xargs -0 -r tar -C . -cvf "$OUT_TAR" --no-recursion
          echo "OUTPUT_TAR=$OUT_TAR" >> $GITHUB_OUTPUT

      - name: Upload packages artifact
        if: ${{ steps.compile.outputs.OUTPUT_TAR != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.branch }}-${{ matrix.arch }}
          path: ${{ steps.compile.outputs.OUTPUT_TAR }}

  gh-pages:
    needs: [check, build]
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: packages-*

      - name: Prepare public repo tree
        run: |
          mkdir -p public
          for f in packages-*.tar; do
            tar -C public -xvf "$f" || true
          done

          printf "%s\n%s\n" \
            "untrusted comment: ByeDPI OpenWrt repo" \
            "RWRT/Cfg5ReIbqWME8QTUQ1FKxp8FTr9M9g1vDsL8uIdRyP5TTNAk4QA" \
            > public/public.key

      - name: Deploy to GH pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
          publish_dir: ./public
          full_commit_message: ByeDPI ${{ needs.check.outputs.tag }}
          force_orphan: true

      - name: Checkout repo to update last tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update .last_release_tag
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          echo "${{ needs.check.outputs.tag }}" > .last_release_tag
          git add .last_release_tag
          git commit -m "Update last_release_tag to ${{ needs.check.outputs.tag }} [skip ci]" || true
          git push

  release:
    needs: [check, build, gh-pages]
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: packages-*

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: packages-*.tar
          tag_name: ${{ needs.check.outputs.tag }}
          name: ByeDPI ${{ needs.check.outputs.tag }}
