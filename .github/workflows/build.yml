permissions:
  contents: write

name: build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 */14 * *'

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Checkout repository (to read .last_release_tag)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get upstream latest release tag
        id: get_tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: 'hufrea/byedpi'
        run: |
          TAG=$(wget -qO- --header="Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/releases/latest" | grep -Po '"tag_name": "\K.+?(?=")')
          echo "Latest upstream tag: $TAG"

          if [ -f .last_release_tag ]; then
            LAST=$(cat .last_release_tag)
          else
            LAST=""
          fi
          echo "Last processed tag: $LAST"

          if [ "$TAG" = "$LAST" ]; then
            echo "tag=SKIP" >> $GITHUB_OUTPUT
            echo "No new release. Skipping build."
            exit 0
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # OpenWrt 19.07 (Docker Hub)
          - branch: openwrt-19.07
            arch: aarch64_cortex-a53
            sdk_image: openwrt/sdk:aarch64_cortex-a53-19.07
          - branch: openwrt-19.07
            arch: aarch64_cortex-a72
            sdk_image: openwrt/sdk:aarch64_cortex-a72-19.07
          - branch: openwrt-19.07
            arch: aarch64_generic
            sdk_image: openwrt/sdk:aarch64_generic-19.07
          - branch: openwrt-19.07
            arch: arm_arm1176jzf-s_vfp
            sdk_image: openwrt/sdk:arm_arm1176jzf-s_vfp-19.07
          - branch: openwrt-19.07
            arch: arm_arm926ej-s
            sdk_image: openwrt/sdk:arm_arm926ej-s-19.07
          - branch: openwrt-19.07
            arch: arm_cortex-a15_neon-vfpv4
            sdk_image: openwrt/sdk:arm_cortex-a15_neon-vfpv4-19.07
          - branch: openwrt-19.07
            arch: arm_cortex-a5_vfpv4
            sdk_image: openwrt/sdk:arm_cortex-a5_vfpv4-19.07
          - branch: openwrt-19.07
            arch: arm_cortex-a8_vfpv3
            sdk_image: openwrt/sdk:arm_cortex-a8_vfpv3-19.07
          - branch: openwrt-19.07
            arch: arm_cortex-a9
            sdk_image: openwrt/sdk:arm_cortex-a9-19.07
          - branch: openwrt-19.07
            arch: arm_cortex-a9_neon
            sdk_image: openwrt/sdk:arm_cortex-a9_neon-19.07
          - branch: openwrt-19.07
            arch: arm_fa526
            sdk_image: openwrt/sdk:arm_fa526-19.07
          - branch: openwrt-19.07
            arch: arm_mpcore
            sdk_image: openwrt/sdk:arm_mpcore-19.07
          - branch: openwrt-19.07
            arch: arm_xscale
            sdk_image: openwrt/sdk:arm_xscale-19.07
          - branch: openwrt-19.07
            arch: mips64_octeonplus
            sdk_image: openwrt/sdk:mips64_octeonplus-19.07
          - branch: openwrt-19.07
            arch: mips_24kc
            sdk_image: openwrt/sdk:mips_24kc-19.07
          - branch: openwrt-19.07
            arch: mips_mips32
            sdk_image: openwrt/sdk:mips_mips32-19.07
          - branch: openwrt-19.07
            arch: mipsel_24kc
            sdk_image: openwrt/sdk:mipsel_24kc-19.07
          - branch: openwrt-19.07
            arch: mipsel_24kc_24kf
            sdk_image: openwrt/sdk:mipsel_24kc_24kf-19.07
          - branch: openwrt-19.07
            arch: mipsel_74kc
            sdk_image: openwrt/sdk:mipsel_74kc-19.07
          - branch: openwrt-19.07
            arch: mipsel_mips32
            sdk_image: openwrt/sdk:mipsel_mips32-19.07
          - branch: openwrt-19.07
            arch: x86_64
            sdk_image: openwrt/sdk:x86_64-19.07

          # OpenWrt 21.02 (GHCR)
          - branch: openwrt-21.02
            arch: aarch64_cortex-a53
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a53-21.02
          - branch: openwrt-21.02
            arch: aarch64_cortex-a72
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a72-21.02
          - branch: openwrt-21.02
            arch: aarch64_generic
            sdk_image: ghcr.io/openwrt/sdk:aarch64_generic-21.02
          - branch: openwrt-21.02
            arch: arm_arm1176jzf-s_vfp
            sdk_image: ghcr.io/openwrt/sdk:arm_arm1176jzf-s_vfp-21.02
          - branch: openwrt-21.02
            arch: arm_arm926ej-s
            sdk_image: ghcr.io/openwrt/sdk:arm_arm926ej-s-21.02
          - branch: openwrt-21.02
            arch: arm_cortex-a15_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a15_neon-vfpv4-21.02
          - branch: openwrt-21.02
            arch: arm_cortex-a5_vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a5_vfpv4-21.02
          - branch: openwrt-21.02
            arch: arm_cortex-a7
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7-21.02
          - branch: openwrt-21.02
            arch: arm_cortex-a7_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7_neon-vfpv4-21.02
          - branch: openwrt-21.02
            arch: arm_cortex-a8_vfpv3
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a8_vfpv3-21.02
          - branch: openwrt-21.02
            arch: arm_cortex-a9
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9-21.02
          - branch: openwrt-21.02
            arch: arm_cortex-a9_neon
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9_neon-21.02
          - branch: openwrt-21.02
            arch: arm_cortex-a9_vfpv3-d16
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9_vfpv3-d16-21.02
          - branch: openwrt-21.02
            arch: arm_fa526
            sdk_image: ghcr.io/openwrt/sdk:arm_fa526-21.02
          - branch: openwrt-21.02
            arch: arm_mpcore
            sdk_image: ghcr.io/openwrt/sdk:arm_mpcore-21.02
          - branch: openwrt-21.02
            arch: arm_xscale
            sdk_image: ghcr.io/openwrt/sdk:arm_xscale-21.02
          - branch: openwrt-21.02
            arch: mips64_octeonplus
            sdk_image: ghcr.io/openwrt/sdk:mips64_octeonplus-21.02
          - branch: openwrt-21.02
            arch: mips_24kc
            sdk_image: ghcr.io/openwrt/sdk:mips_24kc-21.02
          - branch: openwrt-21.02
            arch: mips_4kec
            sdk_image: ghcr.io/openwrt/sdk:mips_4kec-21.02
          - branch: openwrt-21.02
            arch: mips_mips32
            sdk_image: ghcr.io/openwrt/sdk:mips_mips32-21.02
          - branch: openwrt-21.02
            arch: mipsel_24kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc-21.02
          - branch: openwrt-21.02
            arch: mipsel_24kc_24kf
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc_24kf-21.02
          - branch: openwrt-21.02
            arch: mipsel_74kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_74kc-21.02
          - branch: openwrt-21.02
            arch: mipsel_mips32
            sdk_image: ghcr.io/openwrt/sdk:mipsel_mips32-21.02
          - branch: openwrt-21.02
            arch: x86_64
            sdk_image: ghcr.io/openwrt/sdk:x86_64-21.02

          # OpenWrt 22.03 (GHCR)
          - branch: openwrt-22.03
            arch: aarch64_cortex-a53
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a53-22.03
          - branch: openwrt-22.03
            arch: aarch64_cortex-a72
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a72-22.03
          - branch: openwrt-22.03
            arch: aarch64_generic
            sdk_image: ghcr.io/openwrt/sdk:aarch64_generic-22.03
          - branch: openwrt-22.03
            arch: arm_arm1176jzf-s_vfp
            sdk_image: ghcr.io/openwrt/sdk:arm_arm1176jzf-s_vfp-22.03
          - branch: openwrt-22.03
            arch: arm_arm926ej-s
            sdk_image: ghcr.io/openwrt/sdk:arm_arm926ej-s-22.03
          - branch: openwrt-22.03
            arch: arm_cortex-a15_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a15_neon-vfpv4-22.03
          - branch: openwrt-22.03
            arch: arm_cortex-a5_vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a5_vfpv4-22.03
          - branch: openwrt-22.03
            arch: arm_cortex-a7
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7-22.03
          - branch: openwrt-22.03
            arch: arm_cortex-a7_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7_neon-vfpv4-22.03
          - branch: openwrt-22.03
            arch: arm_cortex-a7_vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7_vfpv4-22.03
          - branch: openwrt-22.03
            arch: arm_cortex-a8_vfpv3
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a8_vfpv3-22.03
          - branch: openwrt-22.03
            arch: arm_cortex-a9
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9-22.03
          - branch: openwrt-22.03
            arch: arm_cortex-a9_neon
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9_neon-22.03
          - branch: openwrt-22.03
            arch: arm_cortex-a9_vfpv3-d16
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9_vfpv3-d16-22.03
          - branch: openwrt-22.03
            arch: arm_fa526
            sdk_image: ghcr.io/openwrt/sdk:arm_fa526-22.03
          - branch: openwrt-22.03
            arch: arm_mpcore
            sdk_image: ghcr.io/openwrt/sdk:arm_mpcore-22.03
          - branch: openwrt-22.03
            arch: arm_xscale
            sdk_image: ghcr.io/openwrt/sdk:arm_xscale-22.03
          - branch: openwrt-22.03
            arch: mips64_octeonplus
            sdk_image: ghcr.io/openwrt/sdk:mips64_octeonplus-22.03
          - branch: openwrt-22.03
            arch: mips_24kc
            sdk_image: ghcr.io/openwrt/sdk:mips_24kc-22.03
          - branch: openwrt-22.03
            arch: mips_4kec
            sdk_image: ghcr.io/openwrt/sdk:mips_4kec-22.03
          - branch: openwrt-22.03
            arch: mips_mips32
            sdk_image: ghcr.io/openwrt/sdk:mips_mips32-22.03
          - branch: openwrt-22.03
            arch: mipsel_24kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc-22.03
          - branch: openwrt-22.03
            arch: mipsel_24kc_24kf
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc_24kf-22.03
          - branch: openwrt-22.03
            arch: mipsel_74kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_74kc-22.03
          - branch: openwrt-22.03
            arch: mipsel_mips32
            sdk_image: ghcr.io/openwrt/sdk:mipsel_mips32-22.03
          - branch: openwrt-22.03
            arch: x86_64
            sdk_image: ghcr.io/openwrt/sdk:x86_64-22.03

          # OpenWrt 23.05 (GHCR)
          - branch: openwrt-23.05
            arch: aarch64_cortex-a53
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a53-23.05
          - branch: openwrt-23.05
            arch: aarch64_cortex-a72
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a72-23.05
          - branch: openwrt-23.05
            arch: aarch64_generic
            sdk_image: ghcr.io/openwrt/sdk:aarch64_generic-23.05
          - branch: openwrt-23.05
            arch: arm_arm1176jzf-s_vfp
            sdk_image: ghcr.io/openwrt/sdk:arm_arm1176jzf-s_vfp-23.05
          - branch: openwrt-23.05
            arch: arm_arm926ej-s
            sdk_image: ghcr.io/openwrt/sdk:arm_arm926ej-s-23.05
          - branch: openwrt-23.05
            arch: arm_cortex-a15_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a15_neon-vfpv4-23.05
          - branch: openwrt-23.05
            arch: arm_cortex-a5_vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a5_vfpv4-23.05
          - branch: openwrt-23.05
            arch: arm_cortex-a7
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7-23.05
          - branch: openwrt-23.05
            arch: arm_cortex-a7_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7_neon-vfpv4-23.05
          - branch: openwrt-23.05
            arch: arm_cortex-a7_vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7_vfpv4-23.05
          - branch: openwrt-23.05
            arch: arm_cortex-a8_vfpv3
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a8_vfpv3-23.05
          - branch: openwrt-23.05
            arch: arm_cortex-a9
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9-23.05
          - branch: openwrt-23.05
            arch: arm_cortex-a9_neon
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9_neon-23.05
          - branch: openwrt-23.05
            arch: arm_cortex-a9_vfpv3-d16
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9_vfpv3-d16-23.05
          - branch: openwrt-23.05
            arch: arm_fa526
            sdk_image: ghcr.io/openwrt/sdk:arm_fa526-23.05
          - branch: openwrt-23.05
            arch: arm_mpcore
            sdk_image: ghcr.io/openwrt/sdk:arm_mpcore-23.05
          - branch: openwrt-23.05
            arch: arm_xscale
            sdk_image: ghcr.io/openwrt/sdk:arm_xscale-23.05
          - branch: openwrt-23.05
            arch: mips64_octeonplus
            sdk_image: ghcr.io/openwrt/sdk:mips64_octeonplus-23.05
          - branch: openwrt-23.05
            arch: mips_24kc
            sdk_image: ghcr.io/openwrt/sdk:mips_24kc-23.05
          - branch: openwrt-23.05
            arch: mips_4kec
            sdk_image: ghcr.io/openwrt/sdk:mips_4kec-23.05
          - branch: openwrt-23.05
            arch: mips_mips32
            sdk_image: ghcr.io/openwrt/sdk:mips_mips32-23.05
          - branch: openwrt-23.05
            arch: mipsel_24kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc-23.05
          - branch: openwrt-23.05
            arch: mipsel_24kc_24kf
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc_24kf-23.05
          - branch: openwrt-23.05
            arch: mipsel_74kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_74kc-23.05
          - branch: openwrt-23.05
            arch: mipsel_mips32
            sdk_image: ghcr.io/openwrt/sdk:mipsel_mips32-23.05
          - branch: openwrt-23.05
            arch: x86_64
            sdk_image: ghcr.io/openwrt/sdk:x86_64-23.05

          # OpenWrt 24.10 (GHCR)
          - branch: openwrt-24.10
            arch: aarch64_cortex-a53
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a53-24.10
          - branch: openwrt-24.10
            arch: aarch64_cortex-a72
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a72-24.10
          - branch: openwrt-24.10
            arch: aarch64_generic
            sdk_image: ghcr.io/openwrt/sdk:aarch64_generic-24.10
          - branch: openwrt-24.10
            arch: aarch64_cortex-a76
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a76-24.10
          - branch: openwrt-24.10
            arch: arm_arm1176jzf-s_vfp
            sdk_image: ghcr.io/openwrt/sdk:arm_arm1176jzf-s_vfp-24.10
          - branch: openwrt-24.10
            arch: arm_arm926ej-s
            sdk_image: ghcr.io/openwrt/sdk:arm_arm926ej-s-24.10
          - branch: openwrt-24.10
            arch: arm_cortex-a15_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a15_neon-vfpv4-24.10
          - branch: openwrt-24.10
            arch: arm_cortex-a5_vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a5_vfpv4-24.10
          - branch: openwrt-24.10
            arch: arm_cortex-a7
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7-24.10
          - branch: openwrt-24.10
            arch: arm_cortex-a7_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7_neon-vfpv4-24.10
          - branch: openwrt-24.10
            arch: arm_cortex-a7_vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7_vfpv4-24.10
          - branch: openwrt-24.10
            arch: arm_cortex-a8_vfpv3
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a8_vfpv3-24.10
          - branch: openwrt-24.10
            arch: arm_cortex-a9
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9-24.10
          - branch: openwrt-24.10
            arch: arm_cortex-a9_neon
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9_neon-24.10
          - branch: openwrt-24.10
            arch: arm_cortex-a9_vfpv3-d16
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9_vfpv3-d16-24.10
          - branch: openwrt-24.10
            arch: arm_fa526
            sdk_image: ghcr.io/openwrt/sdk:arm_fa526-24.10
          - branch: openwrt-24.10
            arch: arm_xscale
            sdk_image: ghcr.io/openwrt/sdk:arm_xscale-24.10
          - branch: openwrt-24.10
            arch: mips64_octeonplus
            sdk_image: ghcr.io/openwrt/sdk:mips64_octeonplus-24.10
          - branch: openwrt-24.10
            arch: mips_24kc
            sdk_image: ghcr.io/openwrt/sdk:mips_24kc-24.10
          - branch: openwrt-24.10
            arch: mips_4kec
            sdk_image: ghcr.io/openwrt/sdk:mips_4kec-24.10
          - branch: openwrt-24.10
            arch: mips_mips32
            sdk_image: ghcr.io/openwrt/sdk:mips_mips32-24.10
          - branch: openwrt-24.10
            arch: mipsel_24kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc-24.10
          - branch: openwrt-24.10
            arch: mipsel_24kc_24kf
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc_24kf-24.10
          - branch: openwrt-24.10
            arch: mipsel_74kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_74kc-24.10
          - branch: openwrt-24.10
            arch: mipsel_mips32
            sdk_image: ghcr.io/openwrt/sdk:mipsel_mips32-24.10
          - branch: openwrt-24.10
            arch: x86_64
            sdk_image: ghcr.io/openwrt/sdk:x86_64-24.10

          # OpenWrt 25.12.0-rc4 (GHCR)
          - branch: openwrt-25.12.0-rc4
            arch: aarch64_cortex-a53
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a53-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: aarch64_cortex-a72
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a72-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: aarch64_generic
            sdk_image: ghcr.io/openwrt/sdk:aarch64_generic-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: aarch64_cortex-a76
            sdk_image: ghcr.io/openwrt/sdk:aarch64_cortex-a76-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_arm1176jzf-s_vfp
            sdk_image: ghcr.io/openwrt/sdk:arm_arm1176jzf-s_vfp-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_arm926ej-s
            sdk_image: ghcr.io/openwrt/sdk:arm_arm926ej-s-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_cortex-a15_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a15_neon-vfpv4-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_cortex-a5_vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a5_vfpv4-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_cortex-a7
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_cortex-a7_neon-vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7_neon-vfpv4-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_cortex-a7_vfpv4
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a7_vfpv4-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_cortex-a8_vfpv3
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a8_vfpv3-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_cortex-a9
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_cortex-a9_neon
            sdk_image: ghcr.io/openwrt/sdk:arm_cortex-a9_neon-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_fa526
            sdk_image: ghcr.io/openwrt/sdk:arm_fa526-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: arm_xscale
            sdk_image: ghcr.io/openwrt/sdk:arm_xscale-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: mips64_octeonplus
            sdk_image: ghcr.io/openwrt/sdk:mips64_octeonplus-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: mips_24kc
            sdk_image: ghcr.io/openwrt/sdk:mips_24kc-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: mips_mips32
            sdk_image: ghcr.io/openwrt/sdk:mips_mips32-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: mipsel_24kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: mipsel_24kc_24kf
            sdk_image: ghcr.io/openwrt/sdk:mipsel_24kc_24kf-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: mipsel_74kc
            sdk_image: ghcr.io/openwrt/sdk:mipsel_74kc-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: mipsel_mips32
            sdk_image: ghcr.io/openwrt/sdk:mipsel_mips32-25.12.0-rc4
          - branch: openwrt-25.12.0-rc4
            arch: x86_64
            sdk_image: ghcr.io/openwrt/sdk:x86_64-25.12.0-rc4
    container:
      image: ${{ matrix.sdk_image }}
      options: --user root
    defaults: { run: { shell: bash } }
    env:
      UPSTREAM_TAG: ${{ needs.check.outputs.tag }}
      PKG_TYPE: ${{ contains(matrix.branch, '25.12') && 'apk' || 'ipk' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SDK
        if: ${{ matrix.branch == 'openwrt-23.05' || matrix.branch == 'openwrt-24.10' || matrix.branch == 'openwrt-25.12.0-rc4' }}
        working-directory: /builder
        run: HOME=/builder ./setup.sh

      - name: Prepare package (set version)
        run: |
          sed "s|@VERSION@|${UPSTREAM_TAG#v}|" -i byedpi/Makefile

      - name: Compile package
        id: compile
        working-directory: ${{ matrix.branch == 'openwrt-19.07' && '/home/build/openwrt' || '/builder' }}
        env:
          ARCH: ${{ matrix.arch }}
          BRANCH: ${{ matrix.branch }}
          SIGN_KEY: ${{ secrets.SIGN_PRIVATE_KEY }}
        run: |
          echo "src-link byedpi $GITHUB_WORKSPACE" >> feeds.conf
          ./scripts/feeds update byedpi
          ./scripts/feeds install -a -p byedpi
          make defconfig
          make package/byedpi/compile V=s -j$(nproc) BUILD_LOG=1
          echo "$SIGN_KEY" | base64 -d > key-build
          tar -C ./bin/packages/*/byedpi -cvf $GITHUB_WORKSPACE/$PKG_TYPE-$BRANCH-$ARCH.tar --transform "s|^\./|${BRANCH/openwrt-}/$ARCH/|" --show-transformed-names .

      - name: Compress build logs
        if: ${{ always() }}
        env:
          ARCH: ${{ matrix.arch }}
          BRANCH: ${{ matrix.branch }}
          LOGS_DIR: ${{ matrix.branch == 'openwrt-19.07' && '/home/build/openwrt/logs' || '/builder/logs' }}
        run: |
          if [ -d "$LOGS_DIR" ]; then
            tar -cJvf logs-$BRANCH-$ARCH.tar.xz "$LOGS_DIR"
          else
            echo "No logs dir at $LOGS_DIR â€” skipping compression."
          fi

      - name: Upload packages
        if: ${{ steps.compile.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG_TYPE }}-${{ matrix.branch }}-${{ matrix.arch }}
          path: ${{ env.PKG_TYPE }}-${{ matrix.branch }}-${{ matrix.arch }}.tar
          if-no-files-found: error

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.branch }}-${{ matrix.arch }}
          path: logs-*.tar.xz
          if-no-files-found: ignore

  gh-pages:
    needs: [check, build]
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*-*'

      - name: Prepare files
        run: |
          mkdir -p public
          find . -name '*.tar' -exec tar -C ./public -xvf {} \;
          cat <<EOF >> public/public.key
          untrusted comment: ByeDPI OpenWrt repo
          RWRT/Cfg5ReIbqWME8QTUQ1FKxp8FTr9M9g1vDsL8uIdRyP5TTNAk4QA
          EOF

      - name: Deploy to GH pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          full_commit_message: 'ByeDPI ${{ needs.check.outputs.tag }}'
          force_orphan: true

      - name: Checkout repo to update last tag
        if: ${{ success() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Update .last_release_tag
        if: ${{ success() }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "${{ needs.check.outputs.tag }}" > .last_release_tag
          git add .last_release_tag
          git commit -m "Update last_release_tag to ${{ needs.check.outputs.tag }} [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}

  release:
    needs: [check, build, gh-pages]
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    permissions:
      contents: write
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        branch:
          - '19.07'
          - '21.02'
          - '22.03'
          - '23.05'
          - '24.10'
          - '25.12.0-rc4'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ contains(matrix.branch, '25.12') && 'apk-*' || 'ipk-*' }}

      - name: Prepare files
        env:
          BRANCH: ${{ matrix.branch }}
          PKG_TYPE: ${{ contains(matrix.branch, '25.12') && 'apk' || 'ipk' }}
        run: |
          find . -name "$PKG_TYPE-openwrt-$BRANCH-*.tar" -exec tar -xvf {} --wildcards "*.$PKG_TYPE" \;

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ needs.check.outputs.tag }}-${{ matrix.branch }}
          name: ${{ needs.check.outputs.tag }} for OpenWrt ${{ matrix.branch }}
          target_commitish: gh-pages
          body: |
            ### ByeDPI ${{ needs.check.outputs.tag }} for OpenWrt ${{ matrix.branch }}

            -----
            Check the package architecture of your device using the command:
            ```
            # awk -F\' '/DISTRIB_ARCH/ {print $2}' /etc/openwrt_release
            ```
          files: ./**/*.${{ contains(matrix.branch, '25.12') && 'apk' || 'ipk' }}
          
