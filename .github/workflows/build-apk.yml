name: Build ByeDPI for OpenWrt 25.12 (RC versions)

on:
  workflow_dispatch:
  push:
    branches:
      - byedpi-apk

permissions:
  contents: write

env:
  REPO_NAME: byedpi
  REPO_LNK: hufrea/byedpi
  UPSTREAM_REPO: 'hufrea/byedpi'
  PKGTYPE: apk
  FRIENDLY_NAME: openwrt-25.12

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get upstream latest release tag
        id: get_tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh api repos/${{ env.UPSTREAM_REPO }}/releases/latest --jq '.tag_name')
          echo "Latest upstream tag: $TAG"
          
          if [ -f .last_release_tag_25.12_rc ]; then
            LAST=$(cat .last_release_tag_25.12_rc)
          else
            LAST=""
          fi
          echo "Last processed tag for 25.12 RC: $LAST"
          
          if [ "$TAG" = "$LAST" ]; then
            echo "tag=SKIP" >> $GITHUB_OUTPUT
            echo "No new release. Skipping build."
            exit 0
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        sdk_version: 
          - v25.12.0-rc1
          - v25.12.0-rc2
          - v25.12.0-rc3
          - v25.12.0-rc4
          - v25.12.0-rc5
        arch:
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_arm1176jzf-s_vfp
          - arm_arm926ej-s
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_fa526
          - arm_xscale
          - mips64_octeonplus
          - mips_24kc
          - mips_4kec
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - riscv64_generic
          - x86_64
        exclude:
          - arch: arm_cortex-a9_vfpv3-d16
          - arch: mips_4kec

    container:
      image: ghcr.io/openwrt/sdk:${{ matrix.arch }}-${{ matrix.sdk_version }}
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        id: setup
        run: |
          echo "SDKDIR=/builder" >> $GITHUB_ENV
          echo "ARCH_TAG=${{ matrix.arch }}" >> $GITHUB_ENV
          echo "SDK_VERSION=${{ matrix.sdk_version }}" >> $GITHUB_ENV
          echo "WORKSPACE_PATH=/__w/ByeDPI-OpenWrt/ByeDPI-OpenWrt" >> $GITHUB_ENV

      - name: Fix SDK paths
        run: |
          mkdir -p $SDKDIR/shared-workdir
          rm -rf $SDKDIR/shared-workdir/build
          ln -sf $SDKDIR $SDKDIR/shared-workdir/build

      - name: Setup OpenWrt SDK
        working-directory: ${{ env.SDKDIR }}
        run: |
          wget -qO- 'https://raw.githubusercontent.com/openwrt/keyring/refs/heads/master/gpg/0x1D53D1877742E911.asc' | gpg --verbose --import
          sed -i 's/gpg --/#gpg --/g' setup.sh
          sed -r -i 's/^rm.+//' setup.sh
          ./setup.sh

      - name: Extract version from upstream tag
        id: version
        run: |
          TAG="${{ needs.check.outputs.tag }}"
          VERSION="${TAG#v}"
          echo "UPSTREAM_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Prepare package
        working-directory: ${{ env.WORKSPACE_PATH }}
        run: |
          sed "s|@VERSION@|${{ env.UPSTREAM_VERSION }}|" -i byedpi/Makefile
          mkdir -p ${{ env.SDKDIR }}/package/${{ env.REPO_NAME }}
          cp -r byedpi ${{ env.SDKDIR }}/package/

      - name: Configure feeds and build
        id: compile
        working-directory: ${{ env.SDKDIR }}
        env:
          SIGN_KEY: ${{ secrets.SIGN_PRIVATE_KEY }}
        run: |
          echo "src-link ${{ env.REPO_NAME }} ${{ env.SDKDIR }}/package/${{ env.REPO_NAME }}" >> feeds.conf
          ./scripts/feeds update ${{ env.REPO_NAME }}
          ./scripts/feeds install -a -p ${{ env.REPO_NAME }}
          make defconfig
          sed -i 's/CONFIG_LUCI_JSMIN=y/CONFIG_LUCI_JSMIN=n/g' .config 2>/dev/null || true
          sed -i 's/CONFIG_LUCI_CSSTIDY=y/CONFIG_LUCI_CSSTIDY=n/g' .config 2>/dev/null || true
          make package/${{ env.REPO_NAME }}/compile V=s -j$(nproc) BUILD_LOG=1
          if [ -n "$SIGN_KEY" ]; then
            echo "$SIGN_KEY" | base64 -d > key-build
          fi
          
          mkdir -p /tmp/apk-collection/${{ env.ARCH_TAG }}
          find ./bin -name "byedpi*.apk" -type f -exec cp {} /tmp/apk-collection/${{ env.ARCH_TAG }} \;
          
          if [ -z "$(ls -A /tmp/apk-collection/${{ env.ARCH_TAG }})" ]; then
            echo "ERROR: No APK files found for ${{ env.ARCH_TAG }}"
            find ./bin -type f -name "*.apk" | head -5
            exit 1
          fi
          
          tar -C /tmp/apk-collection -cvf $GITHUB_WORKSPACE/apk-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}.tar ${{ env.ARCH_TAG }}

      - name: Debug APK packaging
        if: steps.compile.outcome == 'success'
        run: |
          echo "=== APK PACKAGING DEBUG INFO ==="
          echo "Architecture: ${{ env.ARCH_TAG }}"
          echo "SDK version: ${{ env.SDK_VERSION }}"
          echo "Workspace path: ${{ env.WORKSPACE_PATH }}"
          echo ""
          echo "1. Contents of /tmp/apk-collection/${{ env.ARCH_TAG }}:"
          ls -la /tmp/apk-collection/${{ env.ARCH_TAG }}/
          echo ""
          echo "2. APK file details:"
          for apk in /tmp/apk-collection/${{ env.ARCH_TAG }}/*.apk; do
            if [ -f "$apk" ]; then
              echo "  - File: $(basename $apk)"
              echo "    Size: $(stat -c%s $apk) bytes"
              # Extract version from filename using grep (sh-compatible)
              version=$(basename "$apk" | grep -o 'byedpi-[0-9][0-9.]*' | cut -d- -f2)
              if [ -n "$version" ]; then
                echo "    Version in filename: $version"
              fi
            fi
          done
          echo ""
          echo "3. Tar archive structure:"
          tar -tvf apk-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}.tar
          echo ""
          echo "4. Generated tar file:"
          ls -la apk-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}.tar
          echo "================================"

      - name: Upload APK packages
        if: steps.compile.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}
          path: apk-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}.tar
          if-no-files-found: error

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}
          path: ${{ env.SDKDIR }}/logs/
          if-no-files-found: ignore

  gh-pages:
    needs: [check, build]
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: apk-*
          path: ./artifacts

      - name: Debug GitHub Pages artifacts
        run: |
          echo "=== GITHUB PAGES ARTIFACTS DEBUG ==="
          find ./artifacts -type f -name "*.tar" | while read f; do
            echo "Found: $f"
            echo "Size: $(stat -c%s "$f") bytes"
            echo "---"
          done
          echo "=============================="

      - name: Prepare files for GitHub Pages
        run: |
          mkdir -p public
          find ./artifacts -name 'apk-*.tar' -exec tar -C ./public -xvf {} \;
          cat > public/public.key << 'EOF'
          untrusted comment: ByeDPI OpenWrt repo
          RWRT/Cfg5ReIbqWME8QTUQ1FKxp8FTr9M9g1vDsL8uIdRyP5TTNAk4QA
          EOF
          
          find ./public -mindepth 1 -type d | while read dir; do
            if [ -n "$(find "$dir" -name '*.apk' -print -quit)" ]; then
              (cd "$dir" && opkg-make-index . > Packages 2>/dev/null || true)
              if [ -f "$dir/Packages" ]; then
                gzip -c "$dir/Packages" > "$dir/Packages.gz" 2>/dev/null || true
              fi
            fi
          done

      - name: Debug GitHub Pages files
        run: |
          echo "=== GITHUB PAGES FILES ==="
          find ./public -type f -name "*.apk" | head -20
          echo "Total APK files: $(find ./public -type f -name "*.apk" | wc -l)"
          echo "======================"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          publish_dir: ./public
          force_orphan: true
          commit_message: 'ByeDPI ${{ needs.check.outputs.tag }} for OpenWrt 25.12 RC'

      - name: Checkout repo to update last tag
        if: ${{ success() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Update .last_release_tag_25.12_rc
        if: ${{ success() }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "${{ needs.check.outputs.tag }}" > .last_release_tag_25.12_rc
          git add .last_release_tag_25.12_rc
          git commit -m "Update last_release_tag_25.12_rc to ${{ needs.check.outputs.tag }} [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}

  release:
    needs: [check, build]
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    permissions:
      contents: write
    runs-on: ubuntu-latest
    env:
      UPSTREAM_VERSION: ${{ needs.check.outputs.tag }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Debug downloaded artifacts
        run: |
          echo "=== DOWNLOADED ARTIFACTS DEBUG ==="
          find ./artifacts -type f -name "*.tar" | while read tar_file; do
            echo "Found: $tar_file"
            echo "File size: $(stat -c%s "$tar_file") bytes"
            echo "Tar contents:"
            tar -tf "$tar_file" 2>/dev/null | head -5 || echo "Failed to list contents"
            echo "---"
          done

      - name: Extract and prepare release files
        id: extract
        run: |
          mkdir -p ./release_files
          
          # Clean version (remove 'v' prefix if present)
          CLEAN_VERSION="${UPSTREAM_VERSION#v}"
          
          # Process all tar files
          find ./artifacts -name "*.tar" -type f | while read tar_file; do
            echo "Processing: $tar_file"
            
            # Extract SDK version and architecture from filename
            filename=$(basename "$tar_file" .tar)
            # Remove 'apk-' prefix
            sdk_arch=${filename#apk-}
            
            # Try to extract SDK version and architecture
            # Format: v25.12.0-rc1-aarch64_cortex-a53
            # We'll use a simple approach: take everything before the last dash as SDK version
            # and the last part as architecture
            SDK_VERSION=$(echo "$sdk_arch" | rev | cut -d'-' -f3- | rev)
            ARCH=$(echo "$sdk_arch" | rev | cut -d'-' -f1,2 | rev)
            
            echo "  SDK version: $SDK_VERSION"
            echo "  Architecture: $ARCH"
            
            # Extract tar file
            TEMP_DIR=$(mktemp -d)
            tar -xf "$tar_file" -C "$TEMP_DIR"
            
            # Find APK files in the extracted directory
            find "$TEMP_DIR" -type f -name "*.apk" | while read apk_file; do
              orig_name=$(basename "$apk_file")
              
              # Extract version from original filename
              file_version=$(echo "$orig_name" | grep -o 'byedpi-[0-9][0-9.]*' | cut -d- -f2)
              if [ -z "$file_version" ]; then
                file_version="$CLEAN_VERSION"
              fi
              
              # Check if filename already contains architecture
              if echo "$orig_name" | grep -q "-${ARCH}\.apk$"; then
                # File already has architecture in name
                new_name="$orig_name"
              else
                # Create new name with architecture and SDK version
                new_name="byedpi-${file_version}-${SDK_VERSION}-${ARCH}.apk"
              fi
              
              echo "    Copying: $orig_name -> $new_name"
              cp "$apk_file" "./release_files/$new_name"
            done
            
            # Clean up
            rm -rf "$TEMP_DIR"
          done
          
          echo ""
          echo "=== FINAL RELEASE FILES ==="
          if ls ./release_files/*.apk 1> /dev/null 2>&1; then
            ls -la ./release_files/
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "Total files: $(ls -1 ./release_files/*.apk 2>/dev/null | wc -l)"
          else
            echo "WARNING: No APK files found in ./release_files/"
            find ./artifacts -type f -name "*.tar" | head -5
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi
          echo "=========================="

      - name: Create Combined Release
        if: steps.extract.outputs.has_files == 'true'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ env.UPSTREAM_VERSION }}-openwrt-25.12-rc
          name: ByeDPI ${{ env.UPSTREAM_VERSION }} for OpenWrt 25.12 (RC versions)
          target_commitish: gh-pages
          body: |
            ### ByeDPI ${{ env.UPSTREAM_VERSION }} for OpenWrt 25.12 RC versions
            
            This release contains APK packages for all RC versions (rc1, rc2, rc3, rc4) and all architectures.
            
            **Note:** Make sure to install the correct architecture package for your device.
            Check your device architecture with:
            ```bash
            awk -F\' '/DISTRIB_ARCH/ {print $2}' /etc/openwrt_release
            ```
          draft: false
          prerelease: true
          files: ./release_files/*.apk
          
