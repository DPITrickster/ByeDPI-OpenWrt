name: Build ByeDPI for OpenWrt 25.12 (RC versions)

on:
  workflow_dispatch:
  push:
    branches:
      - byedpi-apk

permissions:
  contents: write

env:
  REPO_NAME: byedpi
  REPO_LNK: hufrea/byedpi
  UPSTREAM_REPO: 'hufrea/byedpi'
  PKGTYPE: apk
  FRIENDLY_NAME: openwrt-25.12

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get upstream latest release tag
        id: get_tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh api repos/${{ env.UPSTREAM_REPO }}/releases/latest --jq '.tag_name')
          echo "Latest upstream tag: $TAG"
          
          if [ -f .last_release_tag_25.12_rc ]; then
            LAST=$(cat .last_release_tag_25.12_rc)
          else
            LAST=""
          fi
          echo "Last processed tag for 25.12 RC: $LAST"
          
          if [ "$TAG" = "$LAST" ]; then
            echo "tag=SKIP" >> $GITHUB_OUTPUT
            echo "No new release. Skipping build."
            exit 0
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        sdk_version: 
          - v25.12.0-rc1
          - v25.12.0-rc2
          - v25.12.0-rc3
          - v25.12.0-rc4
        arch:
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_arm1176jzf-s_vfp
          - arm_arm926ej-s
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_fa526
          - arm_xscale
          - mips64_octeonplus
          - mips_24kc
          - mips_4kec
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - riscv64_generic
          - x86_64
        exclude:
          - arch: arm_cortex-a9_vfpv3-d16
          - arch: mips_4kec

    container:
      image: ghcr.io/openwrt/sdk:${{ matrix.arch }}-${{ matrix.sdk_version }}
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        id: setup
        run: |
          echo "SDKDIR=/builder" >> $GITHUB_ENV
          echo "ARCH_TAG=${{ matrix.arch }}" >> $GITHUB_ENV
          echo "SDK_VERSION=${{ matrix.sdk_version }}" >> $GITHUB_ENV
          echo "WORKSPACE_PATH=/__w/ByeDPI-OpenWrt/ByeDPI-OpenWrt" >> $GITHUB_ENV

      - name: Fix SDK paths
        run: |
          mkdir -p $SDKDIR/shared-workdir
          rm -rf $SDKDIR/shared-workdir/build
          ln -sf $SDKDIR $SDKDIR/shared-workdir/build

      - name: Setup OpenWrt SDK
        working-directory: ${{ env.SDKDIR }}
        run: |
          wget -qO- 'https://raw.githubusercontent.com/openwrt/keyring/refs/heads/master/gpg/0x1D53D1877742E911.asc' | gpg --verbose --import
          sed -i 's/gpg --/#gpg --/g' setup.sh
          sed -r -i 's/^rm.+//' setup.sh
          ./setup.sh

      - name: Extract version from upstream tag
        id: version
        run: |
          TAG="${{ needs.check.outputs.tag }}"
          VERSION="${TAG#v}"
          echo "UPSTREAM_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Prepare package
        working-directory: ${{ env.WORKSPACE_PATH }}
        run: |
          sed "s|@VERSION@|${{ env.UPSTREAM_VERSION }}|" -i byedpi/Makefile
          mkdir -p ${{ env.SDKDIR }}/package/${{ env.REPO_NAME }}
          cp -r byedpi ${{ env.SDKDIR }}/package/

      - name: Configure feeds and build
        id: compile
        working-directory: ${{ env.SDKDIR }}
        env:
          SIGN_KEY: ${{ secrets.SIGN_PRIVATE_KEY }}
        run: |
          echo "src-link ${{ env.REPO_NAME }} ${{ env.SDKDIR }}/package/${{ env.REPO_NAME }}" >> feeds.conf
          ./scripts/feeds update ${{ env.REPO_NAME }}
          ./scripts/feeds install -a -p ${{ env.REPO_NAME }}
          make defconfig
          sed -i 's/CONFIG_LUCI_JSMIN=y/CONFIG_LUCI_JSMIN=n/g' .config 2>/dev/null || true
          sed -i 's/CONFIG_LUCI_CSSTIDY=y/CONFIG_LUCI_CSSTIDY=n/g' .config 2>/dev/null || true
          make package/${{ env.REPO_NAME }}/compile V=s -j$(nproc) BUILD_LOG=1
          if [ -n "$SIGN_KEY" ]; then
            echo "$SIGN_KEY" | base64 -d > key-build
          fi
          
          # Собираем все найденные APK файлы
          mkdir -p /tmp/apk-collection/${{ env.ARCH_TAG }}
          find ./bin -name "byedpi*.apk" -type f -exec cp {} /tmp/apk-collection/${{ env.ARCH_TAG }} \;
          
          # Проверяем, что файлы найдены
          if [ -z "$(ls -A /tmp/apk-collection/${{ env.ARCH_TAG }})" ]; then
            echo "ERROR: No APK files found for ${{ env.ARCH_TAG }}"
            find ./bin -type f -name "*.apk" | head -5
            exit 1
          fi
          
          # Создаем архив с плоской структурой
          tar -C /tmp/apk-collection -cvf $GITHUB_WORKSPACE/apk-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}.tar ${{ env.ARCH_TAG }}

      - name: Upload APK packages
        if: steps.compile.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}
          path: apk-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}.tar
          if-no-files-found: error

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ env.SDK_VERSION }}-${{ env.ARCH_TAG }}
          path: ${{ env.SDKDIR }}/logs/
          if-no-files-found: ignore

  gh-pages:
    needs: [check, build]
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: apk-*
          path: ./artifacts

      - name: Prepare files for GitHub Pages
        run: |
          mkdir -p public
          find ./artifacts -name 'apk-*.tar' -exec tar -C ./public -xvf {} \;
          cat > public/public.key << 'EOF'
          untrusted comment: ByeDPI OpenWrt repo
          RWRT/Cfg5ReIbqWME8QTUQ1FKxp8FTr9M9g1vDsL8uIdRyP5TTNAk4QA
          EOF
          
          # Генерация индексов для opkg
          find ./public -mindepth 1 -type d | while read dir; do
            if [ -n "$(find "$dir" -name '*.apk' -print -quit)" ]; then
              (cd "$dir" && opkg-make-index . > Packages 2>/dev/null || true)
              if [ -f "$dir/Packages" ]; then
                gzip -c "$dir/Packages" > "$dir/Packages.gz" 2>/dev/null || true
              fi
            fi
          done

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          publish_dir: ./public
          force_orphan: true
          commit_message: 'ByeDPI ${{ needs.check.outputs.tag }} for OpenWrt 25.12 RC'

      - name: Checkout repo to update last tag
        if: ${{ success() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Update .last_release_tag_25.12_rc
        if: ${{ success() }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "${{ needs.check.outputs.tag }}" > .last_release_tag_25.12_rc
          git add .last_release_tag_25.12_rc
          git commit -m "Update last_release_tag_25.12_rc to ${{ needs.check.outputs.tag }} [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}

  release:
    needs: [check, build]
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    permissions:
      contents: write
    runs-on: ubuntu-latest
    env:
      UPSTREAM_VERSION: ${{ needs.check.outputs.tag }}
    strategy:
      max-parallel: 1
      matrix:
        sdk_version:
          - 'v25.12.0-rc1'
          - 'v25.12.0-rc2'
          - 'v25.12.0-rc3'
          - 'v25.12.0-rc4'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: apk-${{ matrix.sdk_version }}-*
          path: ./packages

      - name: Extract and rename APK files
        run: |
          # Создаем директорию для сборки
          mkdir -p ./release_files
          
          # Убираем 'v' из версии
          VERSION="${UPSTREAM_VERSION#v}"
          
          # Обрабатываем каждый архив
          for tar_file in ./packages/apk-${{ matrix.sdk_version }}-*.tar; do
            if [ ! -f "$tar_file" ]; then
              continue
            fi
            
            # Извлекаем архитектуру из имени файла
            filename=$(basename "$tar_file" .tar)
            arch=$(echo "$filename" | sed "s/apk-${{ matrix.sdk_version }}-//")
            
            # Временно извлекаем файлы
            mkdir -p /tmp/extract
            tar -xf "$tar_file" -C /tmp/extract
            
            # Находим и переименовываем APK файл
            find /tmp/extract -name "byedpi*.apk" -type f | while read apk_file; do
              base_name=$(basename "$apk_file")
              new_name="${base_name%.apk}-${arch}.apk"
              cp "$apk_file" "./release_files/$new_name"
              echo "Renamed: $base_name -> $new_name"
            done
            
            # Очищаем временную директорию
            rm -rf /tmp/extract
          done
          
          # Проверяем, что файлы созданы
          echo "Generated files:"
          ls -la ./release_files/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ needs.check.outputs.tag }}-25.12-${{ matrix.sdk_version }}
          name: ByeDPI ${{ needs.check.outputs.tag }} for OpenWrt 25.12 ${{ matrix.sdk_version }}
          target_commitish: gh-pages
          body: |
            ### ByeDPI ${{ needs.check.outputs.tag }} for OpenWrt 25.12 ${{ matrix.sdk_version }}

            Check package architecture:
            ```bash
            awk -F\' '/DISTRIB_ARCH/ {print $2}' /etc/openwrt_release
            ```
          draft: false
          prerelease: true
          files: ./release_files/*.apk
          
